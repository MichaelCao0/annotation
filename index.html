<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HQ1K 图像编辑偏好标注系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 个人信息和标注标准样式 */
        .user-info-section, .guidelines-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 4px solid #4f46e5;
        }

        .user-info-section h3, .guidelines-section h3 {
            color: #1f2937;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-align: center;
        }

        .user-info-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .start-btn, .guidelines-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
        }

        .start-btn:hover, .guidelines-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .guidelines-content {
            max-width: 900px;
            margin: 0 auto;
        }

        .intro {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #e5e7eb;
        }

        .intro p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .evaluation-criteria h4, .rating-scale h4 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .criterion {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .criterion h5 {
            color: #4f46e5;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .criterion p {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
        }

        .rating-scale {
            background: white;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 25px;
        }

        .scale-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .scale-item {
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            border: 2px solid transparent;
        }

        .scale-item.strong-a {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
        }

        .scale-item.strong-b {
            background: #ede9fe;
            color: #7c3aed;
            border-color: #ddd6fe;
        }

        .scale-item.slight-a {
            background: #fed7aa;
            color: #f97316;
            border-color: #fdba74;
        }

        .scale-item.slight-b {
            background: #dbeafe;
            color: #3b82f6;
            border-color: #93c5fd;
        }

        .scale-item.equal-good {
            background: #d1fae5;
            color: #10b981;
            border-color: #a7f3d0;
        }

        .scale-item.equal-bad {
            background: #f3f4f6;
            color: #6b7280;
            border-color: #d1d5db;
        }

        .guidelines-actions {
            text-align: center;
            margin-top: 30px;
        }

        /* 三栏布局 */
        .annotation-area {
            display: grid;
            grid-template-columns: 300px 1fr 1.5fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .guidelines-panel {
            display: flex;
            flex-direction: column;
        }

        .content-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .prompt-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #4f46e5;
        }

        .prompt-section h3 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .original-image {
            text-align: center;
            margin-bottom: 25px;
        }

        .original-image img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .prompt-text {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            line-height: 1.6;
        }

        .prompt-text .english {
            color: #374151;
            margin-bottom: 15px;
            font-style: italic;
        }

        .prompt-text .chinese {
            color: #1f2937;
            font-weight: 500;
        }

        .comparison-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .images-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .image-option {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .image-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .image-option.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .image-option h4 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .image-option img {
            max-width: 100%;
            max-height: 350px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .preference-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .preference-btn {
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
        }

        .preference-btn:hover {
            border-color: #4f46e5;
            color: #4f46e5;
        }

        .preference-btn.selected {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .preference-btn.strong-a {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .preference-btn.slight-a {
            background: #f97316;
            color: white;
            border-color: #f97316;
        }

        .preference-btn.equal-good {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .preference-btn.equal-bad {
            background: #6b7280;
            color: white;
            border-color: #6b7280;
        }

        .preference-btn.slight-b {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .preference-btn.strong-b {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }

        .nav-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn.prev {
            background: #6b7280;
            color: white;
        }

        .nav-btn.next {
            background: #10b981;
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            text-align: center;
            color: #6b7280;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6b7280;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* 标注页面左侧标准说明 - 独立框 */
        .annotation-guidelines-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 16px;
            padding: 25px;
            border: 2px solid #10b981;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.15);
            position: relative;
            overflow: hidden;
        }

        .annotation-guidelines-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #059669, #047857);
        }

        .annotation-guidelines-box h3 {
            color: #065f46;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(16, 185, 129, 0.1);
        }

        .guidelines-compact {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .criterion-compact {
            background: rgba(255, 255, 255, 0.9);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #d1fae5;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .criterion-compact:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
            border-color: #10b981;
        }

        .criterion-compact h5 {
            color: #047857;
            margin-bottom: 8px;
            font-size: 1em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .criterion-compact p {
            color: #374151;
            font-size: 13px;
            line-height: 1.6;
            margin: 0;
            font-weight: 500;
        }

        @media (max-width: 1024px) {
            .annotation-area {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .guidelines-panel {
                order: 1;
            }

            .content-panel {
                order: 2;
            }

            .comparison-section {
                order: 3;
            }
            
            .images-row {
                grid-template-columns: 1fr;
            }
            
            .preference-buttons {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .criteria-grid, .scale-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .annotation-guidelines-box {
                padding: 15px;
            }

            .criterion-compact {
                padding: 12px;
            }

            .criterion-compact h5 {
                font-size: 0.9em;
            }

            .criterion-compact p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HQ1K 图像编辑偏好标注系统</h1>
            <p>请根据编辑指令的执行效果，对两张编辑后的图片进行偏好评估</p>
        </div>

        <div class="content">
            <!-- 个人信息填写区域 -->
            <div id="userInfoSection" class="user-info-section">
                <h3>个人信息</h3>
                <div class="user-info-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userName">姓名：</label>
                            <input type="text" id="userName" placeholder="请输入您的姓名" required>
                        </div>
                        <div class="form-group">
                            <label for="userAge">年龄：</label>
                            <input type="number" id="userAge" min="18" max="80" placeholder="年龄" required>
                        </div>
                        <div class="form-group">
                            <label for="userGender">性别：</label>
                            <select id="userGender" required>
                                <option value="">请选择</option>
                                <option value="male">男</option>
                                <option value="female">女</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userEducation">教育背景：</label>
                            <select id="userEducation" required>
                                <option value="">请选择</option>
                                <option value="highschool">高中及以下</option>
                                <option value="bachelor">本科</option>
                                <option value="master">硕士</option>
                                <option value="phd">博士</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userExperience">图像处理经验：</label>
                            <select id="userExperience" required>
                                <option value="">请选择</option>
                                <option value="none">无经验</option>
                                <option value="basic">基础使用</option>
                                <option value="intermediate">中级水平</option>
                                <option value="advanced">专业水平</option>
                            </select>
                        </div>
                    </div>
                    <button id="startAnnotationBtn" class="start-btn">开始标注</button>
                </div>
            </div>

            <!-- 标注标准说明 -->
            <div id="guidelinesSection" class="guidelines-section" style="display: none;">
                <h3>标注标准</h3>
                <div class="guidelines-content">
                    <div class="intro">
                        <p><strong>这是一份偏好收集问卷，你将看到：</strong></p>
                        <p>一张原图、一段图片编辑指令、两张编辑后的图片。</p>
                    </div>
                    
                    <div class="evaluation-criteria">
                        <h4>评判目标：</h4>
                        <div class="criteria-grid">
                            <div class="criterion">
                                <h5>📋 对齐度</h5>
                                <p>编辑后的图片是否准确地按照给定的编辑指令进行修改。判断时需要看修改是否符合要求，是否在图像中实现了编辑意图。</p>
                            </div>
                            <div class="criterion">
                                <h5>🔧 合理性</h5>
                                <p>图像中的修改是否符合物理或语义上的常理。关注是否存在物理不可能的情况、语义不通的情境、视觉伪影、畸变或断肢等问题。</p>
                            </div>
                            <div class="criterion">
                                <h5>🎨 美学</h5>
                                <p>评估整体的视觉效果，包括构图是否合理，颜色搭配，图像清晰度，风格统一性等。考虑图像的吸引力和协调性。</p>
                            </div>
                            <div class="criterion">
                                <h5>⭐ 总评</h5>
                                <p>基于"对齐度""合理性"和"美学"三个维度的综合评判，得出最终的综合判断。</p>
                            </div>
                        </div>
                    </div>

                    <div class="rating-scale">
                        <h4>评分标准：</h4>
                        <p>每个维度都做一次对比判断并标记"好多少"：</p>
                        <div class="scale-options">
                            <div class="scale-item strong-a">1. A 明显更好</div>
                            <div class="scale-item strong-b">2. B 明显更好</div>
                            <div class="scale-item slight-a">3. A 略好</div>
                            <div class="scale-item slight-b">4. B 略好</div>
                            <div class="scale-item equal-good">5. A 和 B 一样好</div>
                            <div class="scale-item equal-bad">6. A 和 B 一样差</div>
                        </div>
                    </div>

                    <div class="guidelines-actions">
                        <button id="hideGuidelinesBtn" class="guidelines-btn">我已了解，开始标注</button>
                    </div>
                </div>
            </div>

            <div class="progress-bar" id="progressSection" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="loadingDiv" class="loading">
                <h3>正在加载数据...</h3>
                <p>请稍候</p>
            </div>

            <div id="errorDiv" class="error" style="display: none;">
                <h3>加载失败</h3>
                <p id="errorMessage"></p>
            </div>

            <div id="annotationArea" class="annotation-area" style="display: none;">
                <!-- 左侧标注标准独立面板 -->
                <div class="guidelines-panel">
                    <div class="annotation-guidelines-box">
                        <h3>📏 标注标准</h3>
                        <div class="guidelines-compact">
                            <div class="criterion-compact">
                                <h5>📋 对齐度</h5>
                                <p>编辑后的图片是否准确地按照给定的编辑指令进行修改。判断时需要看修改是否符合要求，是否在图像中实现了编辑意图。</p>
                            </div>
                            <div class="criterion-compact">
                                <h5>🔧 合理性</h5>
                                <p>图像中的修改是否符合物理或语义上的常理。关注是否存在物理不可能的情况、语义不通的情境、视觉伪影、畸变或断肢等问题。</p>
                            </div>
                            <div class="criterion-compact">
                                <h5>🎨 美学</h5>
                                <p>评估整体的视觉效果，包括构图是否合理，颜色搭配，图像清晰度，风格统一性等。考虑图像的吸引力和协调性。</p>
                            </div>
                            <div class="criterion-compact">
                                <h5>⭐ 总评</h5>
                                <p>基于"对齐度""合理性"和"美学"三个维度的综合评判，得出最终的综合判断。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 中间原始图片和编辑指令面板 -->
                <div class="content-panel">
                    <div class="prompt-section">
                        <h3>原始图片</h3>
                        <div class="original-image">
                            <img id="originalImage" src="" alt="原始图片">
                        </div>
                        
                        <h3>编辑指令</h3>
                        <div class="prompt-text">
                            <div class="english" id="englishPrompt"></div>
                            <div class="chinese" id="chinesePrompt"></div>
                        </div>
                    </div>
                </div>

                <div class="comparison-section">
                    <h3>请选择您认为更好的编辑结果</h3>
                    <div class="images-row">
                        <div class="image-option" id="imageA">
                            <h4>图片 A</h4>
                            <img id="imageA_img" src="" alt="编辑结果A">
                        </div>
                        <div class="image-option" id="imageB">
                            <h4>图片 B</h4>
                            <img id="imageB_img" src="" alt="编辑结果B">
                        </div>
                    </div>

                    <div class="preference-buttons">
                        <button class="preference-btn" data-preference="strong_a">1. A 明显更好</button>
                        <button class="preference-btn" data-preference="strong_b">2. B 明显更好</button>
                        <button class="preference-btn" data-preference="slight_a">3. A 略好</button>
                        <button class="preference-btn" data-preference="slight_b">4. B 略好</button>
                        <button class="preference-btn" data-preference="equal_good">5. A 和 B 一样好</button>
                        <button class="preference-btn" data-preference="equal_bad">6. A 和 B 一样差</button>
                    </div>
                </div>
            </div>

            <div class="navigation" id="navigationArea" style="display: none;">
                <button class="nav-btn prev" id="prevBtn">上一张</button>
                <div class="status">
                    <span id="currentIndex">1</span> / <span id="totalCount">0</span>
                </div>
                <button class="nav-btn next" id="nextBtn">下一张</button>
            </div>
        </div>
    </div>

    <script>
        class AnnotationInterface {
            constructor() {
                this.currentIndex = 0;
                this.annotations = {};
                this.data = [];
                this.userInfo = {};
                this.init();
            }

            async init() {
                try {
                    await this.loadData();
                    this.setupEventListeners();
                    this.showUserInfoForm();
                } catch (error) {
                    this.showError('数据加载失败: ' + error.message);
                }
            }

            async loadData() {
                try {
                    // 从API加载数据
                    const response = await fetch('/api/dataset/items?per_page=1000');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    this.data = result.items.map(item => ({
                        id: item.id,
                        originalImage: `/images/${item.original_image}`,
                        imageA: `/images/${item.image_a}`,
                        imageB: `/images/${item.image_b}`,
                        englishPrompt: item.english_prompt,
                        chinesePrompt: item.chinese_prompt
                    }));
                    
                    // 加载已保存的标注
                    await this.loadSavedAnnotations();
                    
                } catch (error) {
                    console.error('Failed to load data:', error);
                    // 如果API不可用，回退到模拟数据
                    this.data = Array.from({length: 10}, (_, i) => ({
                        id: `demo_${i}`,
                        originalImage: `https://via.placeholder.com/400x300/cccccc/666666?text=Original+${i}`,
                        imageA: `https://via.placeholder.com/400x300/ff6b6b/ffffff?text=Result+A+${i}`,
                        imageB: `https://via.placeholder.com/400x300/4ecdc4/ffffff?text=Result+B+${i}`,
                        englishPrompt: `Demo edit instruction ${i}: Add some elements to the image`,
                        chinesePrompt: `演示编辑指令 ${i}：在图像中添加一些元素`
                    }));
                    console.warn('Using demo data due to API unavailability');
                }
            }

            setupEventListeners() {
                // 开始标注按钮
                document.getElementById('startAnnotationBtn').addEventListener('click', () => {
                    if (this.validateUserInfo()) {
                        this.collectUserInfo();
                        this.showGuidelines();
                    }
                });

                // 隐藏指南按钮
                document.getElementById('hideGuidelinesBtn').addEventListener('click', () => {
                    this.hideGuidelines();
                    this.showCurrentItem();
                });

                // 偏好选择按钮
                document.querySelectorAll('.preference-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.preference-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        this.annotations[this.data[this.currentIndex].id] = btn.dataset.preference;
                        this.updateUI();
                    });
                });

                // 导航按钮
                document.getElementById('prevBtn').addEventListener('click', () => {
                    if (this.currentIndex > 0) {
                        this.currentIndex--;
                        this.showCurrentItem();
                    }
                });

                document.getElementById('nextBtn').addEventListener('click', () => {
                    if (this.currentIndex < this.data.length - 1) {
                        this.currentIndex++;
                        this.showCurrentItem();
                    }
                });

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    // 只在标注界面激活时使用快捷键
                    if (document.getElementById('annotationArea').style.display === 'none') return;
                    
                    if (e.key === 'ArrowLeft' && this.currentIndex > 0) {
                        this.currentIndex--;
                        this.showCurrentItem();
                    } else if (e.key === 'ArrowRight' && this.currentIndex < this.data.length - 1) {
                        this.currentIndex++;
                        this.showCurrentItem();
                    } else if (e.key >= '1' && e.key <= '6') {
                        const preferences = ['strong_a', 'strong_b', 'slight_a', 'slight_b', 'equal_good', 'equal_bad'];
                        const btn = document.querySelector(`[data-preference="${preferences[parseInt(e.key) - 1]}"]`);
                        if (btn) btn.click();
                    }
                });
            }

            showCurrentItem() {
                if (this.data.length === 0) return;

                const item = this.data[this.currentIndex];
                
                // 更新图片
                document.getElementById('originalImage').src = item.originalImage;
                document.getElementById('imageA_img').src = item.imageA;
                document.getElementById('imageB_img').src = item.imageB;

                // 更新提示文本
                document.getElementById('englishPrompt').textContent = item.englishPrompt;
                document.getElementById('chinesePrompt').textContent = item.chinesePrompt;

                // 更新偏好选择状态
                document.querySelectorAll('.preference-btn').forEach(btn => btn.classList.remove('selected'));
                if (this.annotations[item.id]) {
                    const selectedBtn = document.querySelector(`[data-preference="${this.annotations[item.id]}"]`);
                    if (selectedBtn) selectedBtn.classList.add('selected');
                }

                this.updateUI();
                this.hideLoading();
            }

            updateUI() {
                // 更新进度条
                const progress = ((this.currentIndex + 1) / this.data.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';

                // 更新导航状态
                document.getElementById('currentIndex').textContent = this.currentIndex + 1;
                document.getElementById('totalCount').textContent = this.data.length;

                document.getElementById('prevBtn').disabled = this.currentIndex === 0;
                document.getElementById('nextBtn').disabled = this.currentIndex === this.data.length - 1;

                // 保存标注结果
                this.saveAnnotations();
            }

            hideLoading() {
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('annotationArea').style.display = 'grid';
                document.getElementById('navigationArea').style.display = 'flex';
            }

            showError(message) {
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('errorDiv').style.display = 'block';
                document.getElementById('errorMessage').textContent = message;
            }

            async saveAnnotations() {
                // 保存到本地存储
                localStorage.setItem('hq1k_annotations', JSON.stringify(this.annotations));
                
                // 保存到服务器（包含用户信息）
                try {
                    const response = await fetch('/api/annotations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            annotations: this.annotations,
                            user_info: this.userInfo
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('标注保存成功:', result.message);
                        console.log('保存路径:', result.file_path);
                    } else {
                        console.warn('Failed to save annotations to server');
                    }
                } catch (error) {
                    console.warn('Server not available, saved locally only');
                }
                
                console.log('当前标注进度:', Object.keys(this.annotations).length, '/', this.data.length);
            }

            async loadSavedAnnotations() {
                // 先从服务器加载
                try {
                    const response = await fetch('/api/annotations');
                    if (response.ok) {
                        this.annotations = await response.json();
                        return;
                    }
                } catch (error) {
                    console.warn('Failed to load annotations from server');
                }
                
                // 回退到本地存储
                const saved = localStorage.getItem('hq1k_annotations');
                if (saved) {
                    this.annotations = JSON.parse(saved);
                }
            }

            showUserInfoForm() {
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('userInfoSection').style.display = 'block';
                
                // 加载已保存的用户信息
                const savedUserInfo = localStorage.getItem('hq1k_userInfo');
                if (savedUserInfo) {
                    const userInfo = JSON.parse(savedUserInfo);
                    document.getElementById('userName').value = userInfo.name || '';
                    document.getElementById('userAge').value = userInfo.age || '';
                    document.getElementById('userGender').value = userInfo.gender || '';
                    document.getElementById('userEducation').value = userInfo.education || '';
                    document.getElementById('userExperience').value = userInfo.experience || '';
                }
            }

            validateUserInfo() {
                const name = document.getElementById('userName').value.trim();
                const age = document.getElementById('userAge').value;
                const gender = document.getElementById('userGender').value;
                const education = document.getElementById('userEducation').value;
                const experience = document.getElementById('userExperience').value;

                if (!name) {
                    alert('请输入您的姓名');
                    return false;
                }
                if (!age || age < 18 || age > 80) {
                    alert('请输入有效的年龄（18-80岁）');
                    return false;
                }
                if (!gender) {
                    alert('请选择性别');
                    return false;
                }
                if (!education) {
                    alert('请选择教育背景');
                    return false;
                }
                if (!experience) {
                    alert('请选择图像处理经验');
                    return false;
                }

                return true;
            }

            collectUserInfo() {
                this.userInfo = {
                    name: document.getElementById('userName').value.trim(),
                    age: parseInt(document.getElementById('userAge').value),
                    gender: document.getElementById('userGender').value,
                    education: document.getElementById('userEducation').value,
                    experience: document.getElementById('userExperience').value,
                    timestamp: new Date().toISOString()
                };

                // 保存到本地存储
                localStorage.setItem('hq1k_userInfo', JSON.stringify(this.userInfo));
                
                // 保存到服务器
                this.saveUserInfoToServer();
                console.log('User info collected:', this.userInfo);
            }

            showGuidelines() {
                document.getElementById('userInfoSection').style.display = 'none';
                document.getElementById('guidelinesSection').style.display = 'block';
            }

            hideGuidelines() {
                document.getElementById('guidelinesSection').style.display = 'none';
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('annotationArea').style.display = 'grid';
                document.getElementById('navigationArea').style.display = 'flex';
            }

            async saveUserInfoToServer() {
                try {
                    const response = await fetch('/api/user-info', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(this.userInfo)
                    });
                    
                    if (!response.ok) {
                        console.warn('Failed to save user info to server');
                    }
                } catch (error) {
                    console.warn('Server not available, user info saved locally only');
                }
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            new AnnotationInterface();
        });
    </script>
</body>
</html>
